<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>emc2.simulator.classification &mdash; EMC^2  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> EMC^2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">EMC^2 Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">EMC^2 Usage guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../EMC2example.html"><em>EMCÂ²</em> Demo Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">EMC^2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>emc2.simulator.classification</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for emc2.simulator.classification</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..core</span> <span class="kn">import</span> <span class="n">Instrument</span><span class="p">,</span> <span class="n">Model</span>


<div class="viewcode-block" id="lidar_classify_phase"><a class="viewcode-back" href="../../../API/generated/emc2.simulator.classification.lidar_classify_phase.html#emc2.simulator.classification.lidar_classify_phase">[docs]</a><span class="k">def</span> <span class="nf">lidar_classify_phase</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">beta_p_phase_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">convert_zeros_to_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove_sub_detect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phase classification based on fixed thresholds of a lidar&#39;s LDR and</span>
<span class="sd">    tot beta_p variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instrument: Instrument</span>
<span class="sd">        The instrument to classify. The instrument must be a lidar.</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model output to classify.</span>
<span class="sd">    beta_p_phase_thresh: list of dicts or None</span>
<span class="sd">        If a list, each element contains a dictionary with class name, class integer</span>
<span class="sd">        value (mask order starting at 1), LDR value bounds, and the corresponding beta_p threshold</span>
<span class="sd">        (thresholds are linearly interpolated in log10 scale between LDR values). In order for the</span>
<span class="sd">        method to operate properly, the list should be arranged from the lowest to</span>
<span class="sd">        highest beta_p threshold values for a given LDR, that is, (where i is the list element)</span>
<span class="sd">        beta_p[i+1 | LDR=x] &gt;= beta_p[i | LDR=x]. Set class integer values of 1 or higher = clear</span>
<span class="sd">        (because of a very high beta_p value).</span>
<span class="sd">        When None, the default settings from the instrument object will be used (available only for</span>
<span class="sd">        beta resolving lidar classes).</span>
<span class="sd">    convert_zeros_to_nan: bool</span>
<span class="sd">        If True, saving the mask array as a float dtype (instead of uint8) and converting all</span>
<span class="sd">            zeros in the array to nans.</span>
<span class="sd">    remove_sub_detect: bool</span>
<span class="sd">        If True, remove hydrometeor-bearing grid cells with extinct lidar signal.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model with the added simulated lidar phase classification mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_class</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;lidar&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument must be a lidar!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">beta_p_phase_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="o">.</span><span class="n">beta_p_phase_thresh</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no default threshold values for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">)</span>
        <span class="n">beta_p_phase_thresh</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">beta_p_phase_thresh</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">process_conv</span><span class="p">:</span>
        <span class="n">mask_name_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;strat_phase_mask_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
                         <span class="s2">&quot;conv_phase_mask_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
                         <span class="s2">&quot;phase_mask_</span><span class="si">%s</span><span class="s2">_all_hyd&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">mask_long_name_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> phase classification mask (strat)&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
                              <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> phase classification mask (conv)&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
                              <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> phase classification mask (convective + stratiform)&quot;</span> <span class="o">%</span>
                              <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">LDR_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_LDR_strat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_LDR_conv&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_LDR_tot&quot;</span><span class="p">]</span>
        <span class="n">OD_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_OD_tot_strat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_OD_tot_conv&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_OD_tot&quot;</span><span class="p">]</span>
        <span class="n">beta_p_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_beta_p_tot_strat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_beta_p_tot_conv&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_beta_p_tot&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask_name_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;phase_mask_</span><span class="si">%s</span><span class="s2">_all_hyd&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">mask_long_name_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> phase classification mask (convective + stratiform)&quot;</span> <span class="o">%</span>
                              <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">LDR_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_LDR_tot&quot;</span><span class="p">]</span>
        <span class="n">OD_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_OD_tot&quot;</span><span class="p">]</span>
        <span class="n">beta_p_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_beta_p_tot&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_name_str</span><span class="p">)):</span>
        <span class="n">mask_name</span> <span class="o">=</span> <span class="n">mask_name_str</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">Class_legend</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">beta_p_phase_thresh</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sub_col_LDR_tot&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sub_col_LDR_tot&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">class_type</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">beta_p_phase_thresh</span><span class="p">)):</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">beta_p_fieldnames</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">beta_p_fieldnames</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">&gt;=</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">LDR_fieldnames</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                  <span class="n">beta_p_phase_thresh</span><span class="p">[</span><span class="n">class_type</span><span class="p">][</span><span class="s2">&quot;LDR&quot;</span><span class="p">],</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">beta_p_phase_thresh</span><span class="p">[</span><span class="n">class_type</span><span class="p">][</span><span class="s2">&quot;beta_p&quot;</span><span class="p">])),</span>
                                  <span class="n">beta_p_phase_thresh</span><span class="p">[</span><span class="n">class_type</span><span class="p">][</span><span class="s2">&quot;class_ind&quot;</span><span class="p">],</span> <span class="n">phase_mask</span><span class="p">)</span>
            <span class="n">Class_legend</span><span class="p">[</span><span class="n">beta_p_phase_thresh</span><span class="p">[</span><span class="n">class_type</span><span class="p">][</span><span class="s2">&quot;class_ind&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">beta_p_phase_thresh</span><span class="p">[</span><span class="n">class_type</span><span class="p">][</span><span class="s2">&quot;class&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">remove_sub_detect</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">OD_fieldnames</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="o">.</span><span class="n">ext_OD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phase_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">phase_mask</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;sub_col_LDR_strat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_long_name_str</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unitless&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Class_legend</span>

    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="radar_classify_phase"><a class="viewcode-back" href="../../../API/generated/emc2.simulator.classification.radar_classify_phase.html#emc2.simulator.classification.radar_classify_phase">[docs]</a><span class="k">def</span> <span class="nf">radar_classify_phase</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mask_height_rng</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convert_zeros_to_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phase classification based on cloud occurrence and Ze_min threshold (equivalent</span>
<span class="sd">        to the KAZR-sounding dataset used in Silber et al., ACP, 2020).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instrument: Instrument</span>
<span class="sd">        The instrument to classify. The instrument must be a radar.</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model output to classify.</span>
<span class="sd">    convert_zeros_to_nan: bool</span>
<span class="sd">        If True, saving the mask array as a float dtype (instead of uint8) and converting all</span>
<span class="sd">            zeros in the array to nans.</span>
<span class="sd">    mask_height_rng: tuple or list</span>
<span class="sd">        If None, using all altitudes. Otherwise, limiting to a specific range determined by</span>
<span class="sd">            a two-element tuple or list specifying the height range.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model with the added simulated radar-sounding hydrometeor classification mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_class</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;radar&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument must be a radar!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">process_conv</span><span class="p">:</span>
        <span class="n">mask_name_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;strat_phase_mask_</span><span class="si">%s</span><span class="s2">_sounding&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
                         <span class="s2">&quot;conv_phase_mask_</span><span class="si">%s</span><span class="s2">_sounding&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
                         <span class="s2">&quot;phase_mask_</span><span class="si">%s</span><span class="s2">_sounding_all_hyd&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">mask_long_name_str</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-sounding cloud and precipitation detection output (strat)&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-sounding cloud and precipitation detection output (conv)&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-sounding cloud and precipitation detection output (convective + stratiform)&quot;</span> <span class="o">%</span>
            <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">Ze_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_Ze_att_tot_strat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_Ze_att_tot_conv&quot;</span><span class="p">,</span> <span class="s2">&quot;sub_col_Ze_att_tot&quot;</span><span class="p">]</span>
        <span class="n">cld_exist_cond</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                          <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;conv_frac_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;conv_frac_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask_name_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;phase_mask_</span><span class="si">%s</span><span class="s2">_sounding_all_hyd&quot;</span> <span class="o">%</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">mask_long_name_str</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-sounding cloud and precipitation detection output (convective + stratiform)&quot;</span> <span class="o">%</span>
            <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span><span class="p">]</span>
        <span class="n">Ze_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sub_col_Ze_att_tot&quot;</span><span class="p">]</span>
        <span class="n">cld_exist_cond</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_name_str</span><span class="p">)):</span>
        <span class="n">mask_name</span> <span class="o">=</span> <span class="n">mask_name_str</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">Ze_fieldnames</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;Ze_min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>  <span class="c1"># Precip</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">cld_exist_cond</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">phase_mask</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>  <span class="c1"># Cloud</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">cld_exist_cond</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">phase_mask</span> <span class="o">==</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>  <span class="c1"># Mixed</span>
        <span class="k">if</span> <span class="n">mask_height_rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">z_field</span><span class="p">],</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">mask_height_rng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">z_field</span><span class="p">],</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">mask_height_rng</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phase_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">phase_mask</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_long_name_str</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unitless&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Cloud&quot;</span><span class="p">,</span> <span class="s2">&quot;Mixed&quot;</span><span class="p">,</span> <span class="s2">&quot;Precip&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="lidar_emulate_cosp_phase"><a class="viewcode-back" href="../../../API/generated/emc2.simulator.classification.lidar_emulate_cosp_phase.html#emc2.simulator.classification.lidar_emulate_cosp_phase">[docs]</a><span class="k">def</span> <span class="nf">lidar_emulate_cosp_phase</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">OD_from_sfc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phase_disc_curve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">atb_cross_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cloud_SR_thresh</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">undef_SR_thresh</span><span class="o">=</span><span class="mf">30.</span><span class="p">,</span>
                             <span class="n">inc_precip_hyd_atb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convert_zeros_to_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_ATB</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">hyd_types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Phase classification method to emulate COSP based on attenuated total backscatter</span>
<span class="sd">        (ATB) analysis following Cesana and Chepfer (2013).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    instrument: Instrument</span>
<span class="sd">        The instrument to classify. The instrument must be a lidar.</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model output to classify.</span>
<span class="sd">    eta: float</span>
<span class="sd">        Multiple scattering coefficient.</span>
<span class="sd">    OD_from_sfc: bool</span>
<span class="sd">        If True, optical depth will be calculated from the surface. If False,</span>
<span class="sd">        optical depth will be calculated from the top of the atmosphere.</span>
<span class="sd">    phase_disc_curves: list or None</span>
<span class="sd">        Phase discrimination curve polynomial coefficients (above - liquid, below - ice).</span>
<span class="sd">        When None, the default settings from this method will be used (following Cesana</span>
<span class="sd">        and Chepfer (2013).</span>
<span class="sd">    atb_cross_coeff: dict or None.</span>
<span class="sd">        Dictionary of polynomial coefficients for the estimation of ATB_cross for each</span>
<span class="sd">        hydrometeor type (dict keys).</span>
<span class="sd">        When None, the default coefficients from Cesana and Chepfer (2013) / COSP are used.</span>
<span class="sd">    cloud_SR_thresh: float</span>
<span class="sd">        Scattering ratio threshold for hydrometeor detection.</span>
<span class="sd">    undef_SR_thresh: float</span>
<span class="sd">        Scattering ratio threshold for the undefined phase (layers below a layer with</span>
<span class="sd">        SR values above this threshold are all set to set to &quot;undefined&quot;).</span>
<span class="sd">    inc_precip_hyd_atb: bool</span>
<span class="sd">        If True, include precipitating classes in the calculation of ATB if specified in hyd_types</span>
<span class="sd">        or if hyd_types is None</span>
<span class="sd">    convert_zeros_to_nan: bool</span>
<span class="sd">        If True, saving the mask array as a float dtype (instead of uint8) and converting all</span>
<span class="sd">            zeros in the array to nans.</span>
<span class="sd">    output_ATB: bool</span>
<span class="sd">        If True, save the ATB and scattering ratio fields for each cloud type as well as for</span>
<span class="sd">        all hydrometeors.</span>
<span class="sd">    hyd_types: list or None</span>
<span class="sd">        list of hydrometeor names to include in calcuation. using default Model subclass types if None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model with the added simulated lidar parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hyd_types</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_hyd_types</span><span class="p">(</span><span class="n">hyd_types</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">process_conv</span><span class="p">:</span>
        <span class="n">cld_classes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;conv&quot;</span><span class="p">,</span> <span class="s2">&quot;strat&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cld_classes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;strat&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">instrument_str</span> <span class="o">!=</span> <span class="s2">&quot;HSRL&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instrument must be the 532 nm HSRL (to match CALIOP&#39;s operating wavelength)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">phase_disc_curve</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phase_disc_curve</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9.032e3</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.136e3</span><span class="p">,</span> <span class="mf">173.394</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.951</span><span class="p">,</span> <span class="mf">0.256</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.478e-4</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">atb_cross_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">atb_cross_coeff</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;liq&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.4099</span><span class="p">,</span> <span class="mf">0.009</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ice&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2904</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>

    <span class="k">if</span> <span class="n">inc_precip_hyd_atb</span><span class="p">:</span>
        <span class="n">hyd_classes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;liq&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cl&quot;</span><span class="p">,</span> <span class="s2">&quot;pl&quot;</span><span class="p">],</span> <span class="s2">&quot;ice&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span> <span class="s2">&quot;pi&quot;</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hyd_classes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;liq&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cl&quot;</span><span class="p">],</span> <span class="s2">&quot;ice&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ci&quot;</span><span class="p">]}</span>

    <span class="n">ATB_mol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigma_180_vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.0284</span><span class="p">)</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">beta_p_allhyd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sub_col_beta_p_tot_strat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">beta_p_cross_allhyd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sub_col_beta_p_tot_strat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">OD_allhyd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sub_col_beta_p_tot_strat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cloud_class</span> <span class="ow">in</span> <span class="n">cld_classes</span><span class="p">:</span>
        <span class="n">mask_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_COSP_phase_mask&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">ATB_co</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ATB_cross</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">OD</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">beta_p</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">beta_p_cross</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">hyd_class</span> <span class="ow">in</span> <span class="n">hyd_classes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">OD</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sub_col_beta_p_tot_strat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">beta_p</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sub_col_beta_p_tot_strat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hyd_type</span> <span class="ow">in</span> <span class="n">hyd_classes</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">hyd_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hyd_types</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; not in hyd_types = </span><span class="si">%s</span><span class="s2">; excluding from COSP calculations&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hyd_type</span><span class="p">,</span> <span class="n">hyd_types</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">beta_p</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sub_col_beta_p_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hyd_type</span><span class="p">,</span> <span class="n">cloud_class</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">OD</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sub_col_OD_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hyd_type</span><span class="p">,</span> <span class="n">cloud_class</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">ATB_co</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigma_180_vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                                 <span class="n">beta_p</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">OD</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">])</span>
            <span class="n">ATB_cross</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">atb_cross_coeff</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">],</span> <span class="n">ATB_co</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="n">beta_p_cross</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATB_cross</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">OD</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">])</span> <span class="o">/</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigma_180_vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.0284</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.0284</span><span class="p">)),</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">beta_p_allhyd</span> <span class="o">+=</span> <span class="n">beta_p</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span>
            <span class="n">beta_p_cross_allhyd</span> <span class="o">+=</span> <span class="n">beta_p_cross</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span>
            <span class="n">OD_allhyd</span> <span class="o">+=</span> <span class="n">OD</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]</span>
        <span class="n">ATB_tot</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_p</span><span class="p">[</span><span class="s2">&quot;liq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_p_cross</span><span class="p">[</span><span class="s2">&quot;liq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_p</span><span class="p">[</span><span class="s2">&quot;ice&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_p_cross</span><span class="p">[</span><span class="s2">&quot;ice&quot;</span><span class="p">]</span> <span class="o">+</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigma_180_vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.0284</span><span class="p">),</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">OD</span><span class="p">[</span><span class="s2">&quot;liq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">OD</span><span class="p">[</span><span class="s2">&quot;ice&quot;</span><span class="p">]))</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ATB_cross_tot</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_p_cross</span><span class="p">[</span><span class="s2">&quot;liq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_p_cross</span><span class="p">[</span><span class="s2">&quot;ice&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigma_180_vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span>
                         <span class="p">(</span><span class="mf">0.0284</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.0284</span><span class="p">)),</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="p">(</span><span class="n">OD</span><span class="p">[</span><span class="s2">&quot;liq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">OD</span><span class="p">[</span><span class="s2">&quot;ice&quot;</span><span class="p">]))</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">beta_p_cross</span><span class="p">,</span> <span class="n">ATB_cross</span><span class="p">,</span> <span class="n">ATB_co</span><span class="p">,</span> <span class="n">OD</span><span class="p">,</span> <span class="n">beta_p</span>

        <span class="c1"># Begin cloud detection and phase classification</span>
        <span class="n">SR</span> <span class="o">=</span> <span class="n">ATB_tot</span> <span class="o">/</span> <span class="n">ATB_mol</span>
        <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SR</span> <span class="o">&gt;</span> <span class="n">cloud_SR_thresh</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ATB_cross_tot</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">phase_disc_curve</span><span class="p">,</span> <span class="n">ATB_tot</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">,</span>
                              <span class="n">phase_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">OD_from_sfc</span><span class="p">:</span>
            <span class="n">reflective_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">SR</span> <span class="o">&gt;</span> <span class="n">undef_SR_thresh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reflective_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">SR</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">undef_SR_thresh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">reflective_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">SR</span> <span class="o">&gt;</span> <span class="n">undef_SR_thresh</span><span class="p">,</span> <span class="n">reflective_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                                   <span class="mi">0</span><span class="p">,</span> <span class="n">reflective_mask</span><span class="p">)</span>

        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">T_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                     <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">273.15</span><span class="p">,</span>
                              <span class="n">phase_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">T_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                     <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">233.15</span><span class="p">,</span>
                              <span class="n">phase_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">reflective_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phase_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
            <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phase_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">phase_mask</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;COSP emulation phase classification mask (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unitless&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;liquid&quot;</span><span class="p">,</span> <span class="s2">&quot;ice&quot;</span><span class="p">,</span> <span class="s2">&quot;undef&quot;</span><span class="p">]</span>

        <span class="c1"># save ATB and SR fields for stratiform only</span>
        <span class="k">if</span> <span class="n">output_ATB</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBtot_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">ATB_tot</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBtot_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="s2">&quot;COSP emulation ATB_tot for </span><span class="si">%s</span><span class="s2"> clouds&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBtot_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$m^{-1}\ sr^{-1}$&quot;</span>

            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBcross_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">ATB_cross_tot</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBcross_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="s2">&quot;COSP emulation ATB_cross for </span><span class="si">%s</span><span class="s2"> clouds&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBcross_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$m^{-1}\ sr^{-1}$&quot;</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_SR_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">SR</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_SR_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="s2">&quot;COSP emulation scattering ratio for </span><span class="si">%s</span><span class="s2"> clouds&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_SR_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cloud_class</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$m^{-1}\ sr^{-1}$&quot;</span>

    <span class="c1"># determine phase_mask for all hydrometeors</span>
    <span class="n">ATB_tot_allhyd</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_p_allhyd</span> <span class="o">+</span> <span class="n">beta_p_cross_allhyd</span> <span class="o">+</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigma_180_vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.0284</span><span class="p">),</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">OD_allhyd</span><span class="p">)</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ATB_cross_allhyd</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_p_cross_allhyd</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sigma_180_vol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span>
                        <span class="p">(</span><span class="mf">0.0284</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.0284</span><span class="p">)),</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">OD_allhyd</span><span class="p">)</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Begin cloud detection and phase classification</span>
    <span class="n">mask_name</span> <span class="o">=</span> <span class="s2">&quot;COSP_phase_mask_all_hyd&quot;</span>
    <span class="n">SR_allhyd</span> <span class="o">=</span> <span class="n">ATB_tot_allhyd</span> <span class="o">/</span> <span class="n">ATB_mol</span>
    <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SR_allhyd</span> <span class="o">&gt;</span> <span class="n">cloud_SR_thresh</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
    <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ATB_cross_allhyd</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">phase_disc_curve</span><span class="p">,</span> <span class="n">ATB_tot_allhyd</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">,</span>
                       <span class="n">phase_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">OD_from_sfc</span><span class="p">:</span>
        <span class="n">reflective_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">SR_allhyd</span> <span class="o">&gt;</span> <span class="n">undef_SR_thresh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reflective_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">SR_allhyd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">undef_SR_thresh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">reflective_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">SR_allhyd</span> <span class="o">&gt;</span> <span class="n">undef_SR_thresh</span><span class="p">,</span> <span class="n">reflective_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                               <span class="mi">0</span><span class="p">,</span> <span class="n">reflective_mask</span><span class="p">)</span>

    <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">T_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">273.15</span><span class="p">,</span>
                          <span class="n">phase_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
    <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">T_field</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">num_subcolumns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">233.15</span><span class="p">,</span>
                          <span class="n">phase_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
    <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">reflective_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phase_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">convert_zeros_to_nan</span><span class="p">:</span>
        <span class="n">phase_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phase_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">phase_mask</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">phase_mask</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;COSP emulation phase classification mask (convective + stratiform)&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unitless&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;liquid&quot;</span><span class="p">,</span> <span class="s2">&quot;ice&quot;</span><span class="p">,</span> <span class="s2">&quot;undef&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_ATB</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBtot_all_hyd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">ATB_tot_allhyd</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBtot_all_hyd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="s2">&quot;COSP emulation ATB_tot (convective + stratiform)&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBtot_all_hyd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$m^{-1}\ sr^{-1}$&quot;</span>

        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBcross_all_hyd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">ATB_cross_allhyd</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBcross_all_hyd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="s2">&quot;COSP emulation ATB_cross (convective + stratiform)&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_ATBcross_all_hyd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$m^{-1}\ sr^{-1}$&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_SR_all_hyd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">SR_allhyd</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_q_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_SR_all_hyd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="s2">&quot;COSP emulation scattering ratio (convective + stratiform)&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;COSP_SR_all_hyd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$m^{-1}\ sr^{-1}$&quot;</span>

    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="calculate_phase_ratio"><a class="viewcode-back" href="../../../API/generated/emc2.simulator.classification.calculate_phase_ratio.html#emc2.simulator.classification.calculate_phase_ratio">[docs]</a><span class="k">def</span> <span class="nf">calculate_phase_ratio</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">mask_class</span><span class="p">,</span> <span class="n">mask_allhyd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass_pr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">mpr_subcolmod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hyd_types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate time-height phase ratio field of subcolumn hydrometeor mask for a given class(es).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model output to classify.</span>
<span class="sd">    variable: str</span>
<span class="sd">        The mask variable to process and plot.</span>
<span class="sd">    mask_class: int or list</span>
<span class="sd">        value(s) corresponding to hydrometeor class(es) to calculate the phase ratio for</span>
<span class="sd">        (numerator). Phase ratio is calculated relative to the sum of all hydrometeor classes</span>
<span class="sd">        in subcolumns (defined by mask_allhyd) per time-height grid cell.</span>
<span class="sd">    mask_allhyd: int, list, or None</span>
<span class="sd">        value(s) corresponding to all hydrometeor class(es) to calculate the phase ratio with</span>
<span class="sd">        (denominator). If None, using all non-zero values.</span>
<span class="sd">    mass_pr: bool</span>
<span class="sd">        If True, calcuating the mass phase ratio from the model output where hydrometeors exist</span>
<span class="sd">        in the classification mask. Otherwise, the frequency phase ratio (from all subcolumns).</span>
<span class="sd">    mpr_subcolmod: bool</span>
<span class="sd">        If True, doing subcolumn-based MPR calculation. Otherwise, simply using the model output</span>
<span class="sd">        mixing ratio data.</span>
<span class="sd">    hyd_types: list or None</span>
<span class="sd">        list of hydrometeor names to include in calcuation. using default Model subclass types if None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: Model</span>
<span class="sd">        The model with the added phase ratio field</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hyd_types</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">set_hyd_types</span><span class="p">(</span><span class="n">hyd_types</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">process_conv</span><span class="p">:</span>
        <span class="n">cld_classes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;conv&quot;</span><span class="p">,</span> <span class="s2">&quot;strat&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cld_classes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;strat&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mass_pr</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">liq_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cl&quot;</span><span class="p">,</span> <span class="s2">&quot;pl&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hyd_types</span><span class="p">]</span>
        <span class="n">ice_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span> <span class="s2">&quot;pi&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hyd_types</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mpr_subcolmod</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">mass_subcol_liq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">mass_subcol_ice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cloud_class</span> <span class="ow">in</span> <span class="n">cld_classes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">hyd_class</span> <span class="ow">in</span> <span class="n">liq_classes</span><span class="p">:</span>
                    <span class="n">mass_subcol_liq</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_q_subcolumns_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cloud_class</span><span class="p">,</span> <span class="n">hyd_class</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">hyd_class</span> <span class="ow">in</span> <span class="n">ice_classes</span><span class="p">:</span>
                    <span class="n">mass_subcol_ice</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_q_subcolumns_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cloud_class</span><span class="p">,</span> <span class="n">hyd_class</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">PR</span> <span class="o">=</span> <span class="n">mass_subcol_liq</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass_subcol_liq</span> <span class="o">+</span> <span class="n">mass_subcol_ice</span><span class="p">)</span>
            <span class="n">PR_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">mass_subcol_liq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">mass_subcol_liq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
                                                           <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">mass_subcol_ice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_mpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">PR</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;strat_frac_subcolumns_cl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_mpr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;mass phase ratio&quot;</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_mpr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_mpr_sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">PR_sum</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">T_field</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_mpr_sum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">+</span> \
                <span class="s2">&quot;mass phase ratio with q summed over all hydrometeor containing mask grid cells&quot;</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_mpr_sum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mass_liq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">q_names_stratiform</span><span class="p">[</span><span class="s2">&quot;cl&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">mass_ice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">q_names_stratiform</span><span class="p">[</span><span class="s2">&quot;cl&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hyd_class</span> <span class="ow">in</span> <span class="n">liq_classes</span><span class="p">:</span>
                <span class="n">mass_liq</span> <span class="o">+=</span> <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">q_names_stratiform</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">hyd_class</span> <span class="ow">in</span> <span class="n">ice_classes</span><span class="p">:</span>
                <span class="n">mass_ice</span> <span class="o">+=</span> <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">q_names_stratiform</span><span class="p">[</span><span class="n">hyd_class</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">PR_sum</span> <span class="o">=</span> <span class="n">mass_liq</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass_liq</span> <span class="o">+</span> <span class="n">mass_ice</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;mpr_q&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">PR_sum</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">T_field</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;mpr_q&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">+</span> \
                <span class="s2">&quot;mass phase ratio using model output fields&quot;</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;mpr_q&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_allhyd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask_allhyd</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mask_array</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="n">numer_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="n">mask_class</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">denom_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="n">mask_allhyd</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">denom_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom_counts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">denom_counts</span><span class="p">)</span>
        <span class="n">PR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">numer_counts</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom_counts</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_fpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">PR</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">T_field</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_fpr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot; frequency phase ratio&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_fpr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_fpr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;hyd_numer_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_class</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">variable</span> <span class="o">+</span> <span class="s2">&quot;_fpr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;hyd_denom_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_allhyd</span>

    <span class="k">return</span> <span class="n">model</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Bobby Jackson, Israel Silber.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>